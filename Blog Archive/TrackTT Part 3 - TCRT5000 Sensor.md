Today I will be testing the TCRT5000 sensor. In the previous article, I have covered how to make the motor move forwards and backwards using an arduino. In this article, I will make the motor respond to a sensor, which will control the motor.

## Tasks for today:
- Make the arduino read a signal from the TCRT5000 sensor
- Control a motor with the TCRT5000

## TCRT5000: An introduction
The [TCRT5000](https://www.vishay.com/docs/83760/tcrt5000.pdf) is a simple sensor that emits and detects infrared light. It consists of two parts, the infrared diode and the infrared phototransistor. The IR diode emits infrared light, which bounces off a surface into the phototransistor. When the phototransistor detects IR light, it will allow the current to pass through the emitter. Depending on the amount of light absorbed by the phototransistor, the current will vary in the emitter. With this in mind, a rudimentary lidar can be built.

## Using the TCRT5000 with an Arduino
The TCRT5000 emits analog signals by design. While an Arduino is a digital device, the ATMega328P chip the arduino uses a built-in Analog to Digital Converter (ADC). By using the pins A0-A7, the arduino can read an analog signal generated by the TCRT5000. 
According to the ATMega328P [datasheet](https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-7810-Automotive-Microcontrollers-ATmega328P_Datasheet.pdf) the ADC has the following features:
- A 10-bit resolution with a range of 0V to VCC (usually 5 or 6 volts)
- 8 multiplexed input channels
- A 15k Samples per second sample rate

Using the following circuit diagram, a TCRT5000 sensor can be connected to the arduino:
![How to connect a TCRT5000](https://github.com/tomaszjhuczek/TUD-RoboSumo-Archive/blob/main/Blog%20Archive/Resources/Sensor%20Test%20Circuit%20Schematic%20Part.png?raw=true)

In this circuit, two resistors are present, a 220-Ohm resistor connected in series with the IR LED, and a 10k-Ohm resistor connected with the phototransistor to ground. The 220-Ohm resistor protects the IR LED from overcurrent, and the 10k-Ohm resistor adds a ground reference for the phototransistor (in other words, the phototransistor works similarly to a voltage divider). 

### Testing the TCRT5000 using a serial plotter
Once the circuit is assembled, the sensor can be tested by using this code: 
```c++
void setup() {
    Serial.begin(9600); // Open a serial connection at 9600 baud
}

void loop() {
    int sensor = analogRead(0); // Read voltage in the pin A0
    Serial.println(sensor); // Print the value of sensor to console
}
```
To read the state of the sensor, a built-in serial monitor can be used as well as the built-in serial plotter into the arduino IDE. Alternatively, the serial output can be read from the given serial interface (usually COM1 on Windows, /dev/ttyUSB0 on GNU/linux) using either puTTY or a terminal emulator.
During testing with a serial monitor, a number between 0 and 1023 should generate (1023 is the maximum value possible on a 10-bit ADC). If the number changes when you move a white sheet of paper closer or further from the sensor, then congratulations, the TCRT5000 sensor is working.

### Why use a white sheet of paper?
By using a white sheet of paper, instead of a black one, we can guarantee that the light will reflect from the sheet of paper. However, since black absorbs the light, it can be used to create a mockup of TrackTT tracks using paper and black ink (more on test tracks in a future article).

However, since reading the serial output is only great for testing, we now need to put the sensor into use. In an ideal circumstance, if the sensor detects a surface, it should turn the motor on. Following this simple rule, I wrote the following code, based on the code written in TrackTT Part 2:
```c++
/*
 * Motor Test Code
 * Author: Tomasz J. Huczek
 * This code is licensed under the MIT Licence, please see LICENCE.txt for information.
*/

void setup() {
    pinMode(3, OUTPUT); // Use D3 as output
    pinMode(4, OUTPUT); // Use D4 as output
}

void driveMotor(int direction) {
/*
 * 1 = Forward
 * -1 = Backward
 * Anything else = Stop
     */
    if (direction == 1) {
        digitalWrite(3, HIGH);
        digitalWrite(4, LOW);
    } else if (direction == -1) {
        digitalWrite(4, HIGH);
        digitalWrite(3, LOW);
    } else {
        digitalWrite(4, LOW);
        digitalWrite(3, LOW);
    }
}

void loop() {
    /*
     * Checks if output is above 512 (value to be tuned based on conditions)
     * If it is above 512, the sensor detected a surface, so the motor will drive forward.
     * If it is below 512, the sensor detected empty space, so the motor will stop.
     */
    if (analogRead(0) > 512) {
      driveMotor(1);
    } else {
      driveMotor(0);
    }
}
```
This can be built using this schematic:
![Motor + Sensor](https://github.com/tomaszjhuczek/TUD-RoboSumo-Archive/blob/main/Blog%20Archive/Resources/Sensor%20Test%20Circuit%20Schematic.png?raw=true)

And here is a breadboard version of this circuit:
![Motor + Sensor breadboard](https://github.com/tomaszjhuczek/TUD-RoboSumo-Archive/blob/main/Blog%20Archive/Resources/Sensor+Motor%20Breadboard.jpg?raw=true)
And here is a demo of this code:

<iframe width="560" height="315" src="https://www.youtube.com/embed/Xp42CfgRWDI?si=Z0hNr8yoA4NmMvUl" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Conclusion
With today's task, which was a rather simple one, I was able to get the motor to respond to a signal from the TCRT5000 sensor. In the next article, I will cover the preparations for the TrackTT competition including the design, the code and the strategy, so stay tuned for future posts. Till then enjoy your day.

## Today's Progress Report:
- [x] Motors tested and running when connected to a DC source.
- [x] Arduino moves a single motor forward and backwards.
- [x] Arduino successfully ran both motors in both directions.
- [x] Arduino reads a signal from the TCRT5000 sensor.
- [x] Arduino controls the motor with the signal received from the TCRT5000 sensor.